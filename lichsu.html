<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>L·ªãch s·ª≠ giao d·ªãch - ShynMMO Games</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
<style>
body{background:#0b0f19;color:#fff;font-family:Inter;margin:0;padding:20px}
.card{background:rgba(255,255,255,.05);border-radius:16px;padding:20px;margin:20px auto;max-width:1000px;box-shadow:0 0 20px rgba(0,0,0,.5)}
h2{margin:0 0 10px}
table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
th,td{padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.12);text-align:left}
th{color:#9fb0d1;text-transform:uppercase;font-size:12px;letter-spacing:.06em}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#121826;border:1px solid rgba(255,255,255,.12);font-size:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,button{border:none;border-radius:10px;padding:10px;background:#121826;color:#fff}
button{background:#22d3ee;color:#000;font-weight:700;cursor:pointer}
button:hover{background:#67e8f9}
.info{color:#9fb0d1;font-size:13px;margin-top:6px}
footer{position:fixed;right:20px;bottom:10px;color:#888;font-size:12px;opacity:.6}
a{color:#22d3ee;text-decoration:none}
.amt-pos{color:#10b981;font-weight:700}
.amt-neg{color:#ef4444;font-weight:700}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="./js/firebase.js"></script>
<script src="./js/util.js"></script>
</head>
<body>
<div class="card">
  <h2>üìú L·ªãch s·ª≠ giao d·ªãch</h2>
  <div id="me" class="info">ƒêang t·∫£i...</div>

  <div id="adminTools" class="card" style="display:none;margin-top:16px">
    <h3>üõ† C√¥ng c·ª• Admin</h3>
    <div class="row">
      <input id="uidInput" placeholder="Nh·∫≠p UID ƒë·ªÉ xem l·ªãch s·ª≠ c·ªßa user kh√°c" style="min-width:320px">
      <button id="btnView">Xem</button>
    </div>
    <div class="info">L∆∞u √Ω: Admin c√≥ quy·ªÅn xem l·ªãch s·ª≠ c·ªßa t·∫•t c·∫£ ng∆∞·ªùi d√πng.</div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="row">
      <span class="info">Hi·ªÉn th·ªã g·∫ßn ƒë√¢y nh·∫•t tr∆∞·ªõc</span>
      <div style="margin-left:auto"></div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Th·ªùi gian</th>
          <th>Lo·∫°i</th>
          <th>Game</th>
          <th>S·ªë ti·ªÅn</th>
          <th>Ghi ch√∫</th>
          <th>M√£ ph√≤ng</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="6">ƒêang t·∫£i...</td></tr></tbody>
    </table>
  </div>
</div>
<footer>¬© ShynMMO Games 2025</footer>

<script>
let CURRENT_UID = null;
let IS_ADMIN = false;
let unsub = null;

function ts(t){ const d=new Date(t||Date.now()); return d.toLocaleString('vi-VN'); }

function renderList(uid){
  if(unsub) unsub.off && unsub.off();
  const ref=_db.ref('transactions/'+uid);
  ref.on('value', snap=>{
    const tb = $('#tbody');
    if(!snap.exists()){ tb.innerHTML = '<tr><td colspan="6">Ch∆∞a c√≥ giao d·ªãch</td></tr>'; return; }
    const rows=[];
    snap.forEach(cs=>{
      const v=cs.val();
      rows.push({ id: cs.key, ...v });
    });
    rows.sort((a,b)=> b.time - a.time);
    tb.innerHTML = rows.map(r=>{
      const cls = (r.amount>=0)?'amt-pos':'amt-neg';
      return `<tr>
        <td>${ts(r.time)}</td>
        <td><span class="badge">${r.type}</span></td>
        <td>${r.game||'-'}</td>
        <td class="${cls}">${(r.amount>=0?'+':'')+formatMoney(r.amount)} ƒë</td>
        <td>${r.note||''}</td>
        <td>${r.roomId||'-'}</td>
      </tr>`;
    }).join('');
  });
  // gi·ªØ ref ƒë·ªÉ h·ªßy n·∫øu c·∫ßn
  unsub = ref;
}

requireAuth(async (user)=>{
  const profSnap = await _db.ref('users/'+user.uid).get();
  const prof = profSnap.exists()? profSnap.val(): null;
  IS_ADMIN = !!(prof && prof.role==='admin');
  CURRENT_UID = user.uid;

  $('#me').innerHTML = `B·∫°n ƒëang ƒëƒÉng nh·∫≠p: <b>${prof?.username||user.uid}</b> ‚Äî S·ªë d∆∞: <b>${formatMoney(prof?.balance||0)}ƒë</b> ${IS_ADMIN? ' <span class="badge">ADMIN</span>':''}`;

  if(IS_ADMIN) $('#adminTools').style.display='block';

  renderList(CURRENT_UID);
});

// Admin xem UID kh√°c
$('#btnView').onclick = ()=>{
  if(!IS_ADMIN) return toast('B·∫°n kh√¥ng c√≥ quy·ªÅn admin');
  const id = $('#uidInput').value.trim();
  if(!id) return;
  CURRENT_UID = id;
  renderList(id);
};
</script>
</body>
</html>
