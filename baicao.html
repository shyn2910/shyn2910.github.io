<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>B√†i C√†o - ShynMMO Games</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
<style>
body{background:#0b0f19;color:#fff;font-family:Inter;margin:0;padding:20px}
.card{background:rgba(255,255,255,0.05);border-radius:15px;padding:20px;margin:20px auto;max-width:900px;box-shadow:0 0 15px rgba(0,0,0,0.5)}
input,select,button{border:none;border-radius:10px;padding:10px;margin:5px;background:#121826;color:#fff}
button{background:#22d3ee;color:#000;font-weight:700;cursor:pointer}
button:hover{background:#67e8f9}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
.player-card{background:#111b2d;border-radius:12px;padding:10px;text-align:center}
footer{position:fixed;right:20px;bottom:10px;color:#888;font-size:12px;opacity:.6}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#121826;border:1px solid rgba(255,255,255,.12);font-size:12px}
.small{color:#9fb0d1;font-size:13px}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="./js/firebase.js"></script>
<script src="./js/util.js"></script>
</head>
<body>
<div class="card">
  <h2>üÉè B√†i C√†o realtime</h2>
  <div class="flex">
    <button id="btnLeave">R·ªùi ph√≤ng</button>
    <button id="btnReady">S·∫µn s√†ng</button>
    <button id="btnStart" style="display:none">B·∫Øt ƒë·∫ßu v√°n</button>
  </div>
  <div id="info" class="small"></div>
  <hr>
  <div class="flex">
    <input id="roomName" placeholder="T√™n ph√≤ng">
    <button id="btnCreate">T·∫°o ph√≤ng</button>
  </div>
  <div id="rooms" class="grid"></div>
</div>

<footer>¬© ShynMMO Games 2025</footer>

<script>
// ===== Kh·ªüi t·∫°o =====
requireAuth(async(user)=>{
  const udata=(await _db.ref('users/'+user.uid).get()).val();
  window.myUser={uid:user.uid,...udata};
  toast("Xin ch√†o "+myUser.username);
});

// ===== Danh s√°ch ph√≤ng =====
const roomsRef=_db.ref('rooms/baicao');
roomsRef.on('value',snap=>{
  const wrap=$('#rooms');wrap.innerHTML='';
  if(!snap.exists()){wrap.innerHTML='<p>Ch∆∞a c√≥ ph√≤ng n√†o</p>';return;}
  snap.forEach(cs=>{
    const r=cs.val();const id=cs.key;
    const div=document.createElement('div');
    div.className='player-card';
    div.innerHTML=`<b>${r.name}</b><br>${Object.keys(r.players||{}).length} ng∆∞·ªùi<br>
      <button data-id="${id}">V√†o ph√≤ng</button>`;
    div.querySelector('button').onclick=()=>joinRoom(id);
    wrap.appendChild(div);
  });
});

// ===== T·∫°o ph√≤ng =====
$('#btnCreate').onclick=async()=>{
  const name=$('#roomName').value.trim()||("Ph√≤ng "+Math.floor(Math.random()*999));
  const ref=roomsRef.push();
  await ref.set({name,hostUid:uid(),status:'waiting',pot:0,createdAt:Date.now(),players:{}});
  joinRoom(ref.key);
};

// ===== V√†o ph√≤ng =====
async function joinRoom(roomId){
  const ref=_db.ref('rooms/baicao/'+roomId+'/players/'+uid());
  const profile=(await _db.ref('users/'+uid()).get()).val();
  await ref.set({username:profile.username,bet:0,ready:false,score:0});
  toast("ƒê√£ v√†o ph√≤ng "+roomId);
  loadRoom(roomId);
}

let currentRoom=null;
function loadRoom(roomId){
  currentRoom=roomId;
  const roomRef=_db.ref('rooms/baicao/'+roomId);
  roomRef.on('value',snap=>{
    if(!snap.exists())return;
    const r=snap.val();const me=uid();
    const players=r.players||{};
    const info=$('#info');
    let html=`<h3>${r.name}</h3>`;
    html+=`<p>Tr·∫°ng th√°i: ${r.status}</p>`;
    html+=`<div class='grid'>`;
    for(const id in players){
      const p=players[id];
      html+=`<div class='player-card'><b>${p.username}</b><br>
             C∆∞·ª£c: ${formatMoney(p.bet)}<br>
             ${p.ready?'‚úÖ S·∫µn s√†ng':'‚è≥ Ch·ªù'}<br>
             ƒêi·ªÉm: ${p.score||'-'}</div>`;
    }
    html+='</div>';
    if(r.lastWinner) html+=`<p>üéâ Ch√∫c m·ª´ng <b>${r.lastWinner.username}</b> ƒë√£ th·∫Øng <b>${formatMoney(r.lastWinner.amount)}ƒë</b></p>`;
    info.innerHTML=html;

    // hi·ªÉn th·ªã n√∫t host
    $('#btnStart').style.display = (r.hostUid===me && Object.values(players).length>=2) ? 'inline-block' : 'none';
  });
}

// ===== R·ªùi ph√≤ng =====
$('#btnLeave').onclick=async()=>{
  if(!currentRoom)return;
  await _db.ref('rooms/baicao/'+currentRoom+'/players/'+uid()).remove();
  toast("ƒê√£ r·ªùi ph√≤ng");
  currentRoom=null;
};

// ===== S·∫µn s√†ng =====
$('#btnReady').onclick=async()=>{
  if(!currentRoom)return;
  const ref=_db.ref('rooms/baicao/'+currentRoom+'/players/'+uid());
  await ref.update({ready:true});
  toast("ƒê√£ s·∫µn s√†ng");
};

// ===== B·∫Øt ƒë·∫ßu v√°n (Host) =====
$('#btnStart').onclick=async()=>{
  if(!currentRoom)return;
  const roomRef=_db.ref('rooms/baicao/'+currentRoom);
  const snap=await roomRef.get();
  const r=snap.val();
  const players=r.players||{};
  const active=Object.keys(players).filter(u=>players[u].ready);
  if(active.length<2)return toast("C·∫ßn √≠t nh·∫•t 2 ng∆∞·ªùi ch∆°i");

  // Gi·ªõi h·∫°n c∆∞·ª£c 10k‚Äì500k (demo: random trong kho·∫£ng)
  let pot=0;
  const deck=[...Array(52).keys()].sort(()=>Math.random()-0.5);
  const val=c=>((c%13)+1>10?10:(c%13)+1);
  const updates={};
  active.forEach((uid,i)=>{
    const cards=deck.slice(i*3,i*3+3);
    const score=(cards.map(val).reduce((a,b)=>a+b,0))%10;
    // ƒë·∫∑t c∆∞·ª£c ng·∫´u nhi√™n 10k‚Äì500k chia b·ªôi 10k (c√≥ th·ªÉ thay b·∫±ng UI)
    const unit = 10000;
    const bet = Math.min(500000, Math.max(10000, (1+Math.floor(Math.random()*50))*unit));
    pot+=bet;
    updates[`players/${uid}/cards`]=cards;
    updates[`players/${uid}/score`]=score;
    updates[`players/${uid}/bet`]=bet;
  });

  // T√¨m winner
  const maxScore=Math.max(...active.map(u=>updates[`players/${u}/score`]));
  const winners=active.filter(u=>updates[`players/${u}/score`]===maxScore);
  const prize=Math.floor(pot/winners.length);

  // C·ªông ti·ªÅn + log + C·ªòNG BXH
  for(const w of winners){
    const profRef=_db.ref('users/'+w);
    await profRef.child('balance').transaction(b=> (b||0)+prize);
    await logTransaction(w,"win",prize,"baicao","Th·∫Øng v√°n b√†i c√†o", currentRoom);
    await incLeaderboardOnWin('baicao', w, prize); // <-- PATCH leaderboard
    // Nh·ªØng ng∆∞·ªùi kh√¥ng th·∫Øng (ƒë√£ c∆∞·ª£c) ghi lose: -bet
  }
  // Ghi thua cho ng∆∞·ªùi kh√¥ng th·∫Øng (m·ª©c thua l√† s·ªë ti·ªÅn h·ªç ƒë√£ g√≥p pot)
  for(const u of active){
    if(!winners.includes(u)){
      const lost = updates[`players/${u}/bet`] || 0;
      await logTransaction(u,"lose",-lost,"baicao","Thua v√°n b√†i c√†o", currentRoom);
      // (s·ªë d∆∞ ƒë√£ b·ªã tr·ª´ khi ƒë·∫∑t ‚Äî ·ªü b·∫£n demo n√†y m√¨nh tr·ª´ khi k·∫øt v√°n qua log, n·∫øu b·∫°n mu·ªën tr·ª´ tr∆∞·ªõc, chuy·ªÉn logic.)
    }
  }

  await roomRef.update({...updates,lastWinner:{username:r.players[winners[0]].username,amount:prize}, status:'waiting'});
  toast("V√°n ƒë√£ k·∫øt th√∫c!");
};
</script>
</body>
</html>
