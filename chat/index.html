<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ShynChat Pro v4.0 üí¨</title>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-storage-compat.js"></script>
<style>
  :root {
    --bg: #0a0a0a;
    --text: #fff;
    --msg: #1b1b1b;
    --accent: #ff2e2e;
  }
  body.light {
    --bg: #f5f5f5;
    --text: #111;
    --msg: #fff;
    --accent: #ff5555;
  }
  body {
    font-family: 'Be Vietnam Pro', sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    margin: 0;
    transition: background 0.3s, color 0.3s;
  }
  h2 {
    margin-top: 20px;
    color: var(--accent);
    text-shadow: 0 0 15px var(--accent);
  }
  #chat-container {
    display: none;
    width: 90%;
    max-width: 700px;
    border: 1px solid var(--accent);
    border-radius: 10px;
    box-shadow: 0 0 25px var(--accent);
    margin-top: 20px;
    padding: 15px;
    background: var(--msg);
  }
  #chat-box {
    height: 55vh;
    overflow-y: auto;
    padding: 10px;
    border-radius: 8px;
    background: var(--bg);
    box-shadow: inset 0 0 10px var(--accent);
  }
  .msg {
    text-align: left;
    margin: 8px 0;
    background: var(--msg);
    padding: 10px;
    border-radius: 8px;
    position: relative;
  }
  .msg:hover { background: rgba(255,255,255,0.08); }
  .msg img { max-width: 160px; border-radius: 6px; margin-top: 4px; }
  .user { font-weight: bold; color: var(--accent); cursor: pointer; }
  .time { font-size: 0.75em; opacity: 0.7; }
  #typing { font-style: italic; color: #aaa; margin: 4px 0; height: 20px; }
  #online-users { margin: 10px 0; padding: 10px; background: var(--bg); border-radius: 8px; }
  textarea { width: 90%; background: var(--msg); color: var(--text); border-radius: 6px; border: 1px solid var(--accent); padding: 8px; }
  button {
    background: var(--accent);
    border: none;
    color: white;
    padding: 6px 12px;
    margin: 5px;
    border-radius: 6px;
    cursor: pointer;
  }
  #theme-toggle { position: fixed; top: 10px; right: 10px; cursor: pointer; }
</style>
</head>
<body>

<h2>üí¨ ShynChat Pro v4.0 | ShynSuite</h2>
<button id="theme-toggle">üåô</button>

<div id="login-section">
  <button id="googleLogin">ƒêƒÉng nh·∫≠p b·∫±ng Google</button>
</div>

<div id="chat-container">
  <div id="user-info"></div>
  <div id="online-users"></div>
  <div id="chat-box"></div>
  <div id="typing"></div>

  <textarea id="message" placeholder="Nh·∫≠p tin nh·∫Øn... (Enter = g·ª≠i, Shift+Enter = xu·ªëng d√≤ng)"></textarea><br>
  <input type="file" id="imageInput" accept="image/*">
  <button onclick="sendMessage()">G·ª≠i</button>
  <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
</div>

<audio id="notifSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>

<script>
  // Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDs3VrMSUnb7kl0MWYbMxnqR78anJ2SgJs",
  authDomain: "shynchat.firebaseapp.com",
  projectId: "shynchat",
  storageBucket: "shynchat.firebasestorage.app",
  messagingSenderId: "180611398927",
  appId: "1:180611398927:web:2566534da0f8f6935f927a",
  measurementId: "G-8876T182RZ"
};	
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();
  const provider = new firebase.auth.GoogleAuthProvider();

  // Elements
  const googleLogin = document.getElementById("googleLogin");
  const loginSection = document.getElementById("login-section");
  const chatContainer = document.getElementById("chat-container");
  const chatBox = document.getElementById("chat-box");
  const messageInput = document.getElementById("message");
  const imageInput = document.getElementById("imageInput");
  const typing = document.getElementById("typing");
  const onlineUsers = document.getElementById("online-users");
  const userInfo = document.getElementById("user-info");
  const notifSound = document.getElementById("notifSound");
  const themeToggle = document.getElementById("theme-toggle");

  let currentUser = null;
  let currentRoom = "public";
  let typingRef = null;

  googleLogin.onclick = () => auth.signInWithPopup(provider);
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      loginSection.style.display = "none";
      chatContainer.style.display = "block";
      userInfo.innerHTML = `<img src="${user.photoURL}" width="40" style="border-radius:50%"> ${user.displayName}`;
      setUserOnline(user.uid, user.displayName, user.email);
      loadUsers();
      loadMessages();
      setupTypingIndicator();
    } else {
      loginSection.style.display = "block";
      chatContainer.style.display = "none";
    }
  });

  function logout() { auth.signOut(); }

  // Online management
  function setUserOnline(uid, name, email) {
    const ref = db.ref("users/" + uid);
    ref.set({ name, email, online: true });
    ref.onDisconnect().remove();
    window.addEventListener("beforeunload", () => ref.remove());
  }

  function loadUsers() {
    db.ref("users").on("value", snap => {
      onlineUsers.innerHTML = "<b>üü¢ ƒêang online:</b><br>";
      snap.forEach(child => {
        const u = child.val();
        const div = document.createElement("div");
        div.textContent = u.name;
        div.className = "user";
        div.oncontextmenu = e => {
          e.preventDefault();
          if (currentUser.email === "admin@shyn.vn") {
            const action = prompt("Ch·ªçn: Delete/Ban/Chat");
            if (action?.toLowerCase() === "ban") db.ref("users/" + child.key).remove();
            if (action?.toLowerCase() === "chat") startPrivateChat(u.name);
          } else startPrivateChat(u.name);
        };
        onlineUsers.appendChild(div);
      });
    });
  }

  function loadMessages() {
    chatBox.innerHTML = "";
    db.ref("rooms/" + currentRoom).on("child_added", snap => {
      const d = snap.val();
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<span class="user">${d.userName}</span>: ${d.text || ""}
        ${d.imageUrl ? `<img src="${d.imageUrl}">` : ""}
        <div class="time">${new Date(d.time).toLocaleTimeString()}</div>`;
      div.ondblclick = () => div.innerHTML += " üòä"; // Emoji reaction
      div.oncontextmenu = e => {
        e.preventDefault();
        if (currentUser.email === "admin@shyn.vn") {
          const c = confirm("X√≥a tin nh·∫Øn n√†y?");
          if (c) db.ref("rooms/" + currentRoom + "/" + snap.key).remove();
        }
      };
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      if (d.userEmail !== currentUser.email) notifSound.play();
    });
  }

  async function sendMessage() {
    const text = messageInput.value.trim();
    const file = imageInput.files[0];
    if (!text && !file) return;
    let imageUrl = null;
    if (file) {
      const ref = storage.ref("chatImages/" + Date.now() + "_" + file.name);
      await ref.put(file);
      imageUrl = await ref.getDownloadURL();
      imageInput.value = "";
    }
    db.ref("rooms/" + currentRoom).push({
      userName: currentUser.displayName,
      userEmail: currentUser.email,
      text, imageUrl, time: Date.now()
    });
    messageInput.value = "";
    db.ref("typing/" + currentRoom + "/" + currentUser.uid).remove();
  }

  messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    } else {
      db.ref("typing/" + currentRoom + "/" + currentUser.uid)
        .set(currentUser.displayName);
    }
  });

  // Typing indicator
  function setupTypingIndicator() {
    db.ref("typing/" + currentRoom).on("value", snap => {
      const val = snap.val();
      if (val) {
        const names = Object.values(val).filter(n => n !== currentUser.displayName);
        typing.textContent = names.length ? `${names.join(", ")} ƒëang nh·∫≠p...` : "";
      } else typing.textContent = "";
    });
  }

  // Private chat
  function startPrivateChat(target) {
    if (target === currentUser.displayName) return;
    currentRoom = `private_${[currentUser.displayName, target].sort().join("_")}`;
    alert("ƒêang chat ri√™ng v·ªõi " + target);
    loadMessages();
    setupTypingIndicator();
  }

  // Theme toggle
  let isDark = true;
  themeToggle.onclick = () => {
    isDark = !isDark;
    document.body.classList.toggle("light", !isDark);
    themeToggle.textContent = isDark ? "üåô" : "‚òÄÔ∏è";
  };
</script>
</body>
</html>
