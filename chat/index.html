<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ShynChat Pro v4.4 💬 | ShynSuite</title>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-storage-compat.js"></script>

<style>
  body { font-family: 'Be Vietnam Pro', sans-serif; background: #0a0a0a; color: #fff; text-align: center; }
  #chat-container { display: none; margin-top: 20px; background: #111; border-radius: 10px; width: 90%; max-width: 700px; padding: 20px; box-shadow: 0 0 20px #ff2e2e; }
  .msg { background: #1b1b1b; margin: 6px; padding: 8px; border-radius: 8px; text-align: left; }
  .user { font-weight: bold; color: #ff2e2e; }
  .time { font-size: 0.75em; opacity: 0.7; }
  textarea { width: 90%; height: 60px; background: #222; color: white; border-radius: 8px; border: 1px solid #ff2e2e; }
</style>
</head>
<body>

<h2>🔥 ShynChat Pro v4.4 | ShynSuite</h2>
<button id="googleLogin">Đăng nhập bằng Google</button>

<div id="chat-container">
  <div id="user-info"></div>
  <div id="room-label">PHÒNG CHUNG</div>
  <div id="online-users"></div>
  <div id="chat-box"></div>
  <div id="typing"></div>
  <textarea id="message" placeholder="Nhập tin nhắn..."></textarea><br>
  <input type="file" id="imageInput" accept="image/*">
  <button onclick="sendMessage()">Gửi</button>
  <button onclick="logout()">Đăng xuất</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDs3VrMSUnb7kl0MWYbMxnqR78anJ2SgJs",
  authDomain: "shynchat.firebaseapp.com",
  databaseURL: "https://shynchat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shynchat",
  storageBucket: "shynchat.firebasestorage.app",
  messagingSenderId: "180611398927",
  appId: "1:180611398927:web:2566534da0f8f6935f927a",
  measurementId: "G-8876T182RZ"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.database(),storage=firebase.storage();
const provider=new firebase.auth.GoogleAuthProvider();

const gLogin=document.getElementById("googleLogin");
const chatBox=document.getElementById("chat-box");
const msg=document.getElementById("message");
const typing=document.getElementById("typing");
const users=document.getElementById("online-users");
const chatContainer=document.getElementById("chat-container");
const imageInput=document.getElementById("imageInput");

let currentUser=null;
let currentRoom="public";
let typingTimeout=null;

// === Đăng nhập ===
gLogin.onclick=()=>auth.signInWithPopup(provider);
auth.onAuthStateChanged(user=>{
  if(user){
    currentUser=user;
    gLogin.style.display="none";
    chatContainer.style.display="block";
    setOnline(true);
    loadUsers();
    loadMessages();
    setupTyping();
  }
});

// === Theo dõi Online ===
function setOnline(state){
  const ref=db.ref("users/"+currentUser.uid);
  ref.update({name:currentUser.displayName,email:currentUser.email,online:state,lastActive:Date.now()});
  window.addEventListener("beforeunload",()=>ref.update({online:false,lastActive:Date.now()}));
  ref.onDisconnect().update({online:false,lastActive:Date.now()});
}
function logout(){
  setOnline(false);
  auth.signOut();
  location.reload();
}

// === Hiển thị danh sách online ===
function loadUsers(){
  db.ref("users").on("value",snap=>{
    users.innerHTML="<b>🟢 Online:</b><br>";
    snap.forEach(c=>{
      const u=c.val();
      if(!u.name)return;
      const div=document.createElement("div");
      div.textContent=u.name+(u.online?" 🟢":" 🔴");
      users.appendChild(div);
    });
  });
}

// === Tin nhắn ===
function loadMessages(){
  db.ref("rooms/public").on("child_added",s=>{
    const d=s.val();
    const div=document.createElement("div");
    div.className="msg";
    div.innerHTML=`<span class="user">${d.userName}</span>: ${d.text||""}
      ${d.imageUrl?`<br><img src="${d.imageUrl}" width="150">`:""}
      <div class="time">${new Date(d.time).toLocaleTimeString()}</div>`;
    chatBox.appendChild(div);
    chatBox.scrollTop=chatBox.scrollHeight;
  });
}

// === Gửi tin ===
async function sendMessage(){
  const text=msg.value.trim();
  const file=imageInput.files[0];
  if(!text&&!file)return;
  let imageUrl=null;
  if(file){
    const ref=storage.ref("chatImages/"+Date.now()+"_"+file.name);
    await ref.put(file);imageUrl=await ref.getDownloadURL();
    imageInput.value="";
  }
  db.ref("rooms/public").push({
    userName:currentUser.displayName,userEmail:currentUser.email,text,imageUrl,time:Date.now()
  });
  msg.value="";
  db.ref("typing/public/"+currentUser.uid).remove();
}

// === Typing Indicator ===
msg.addEventListener("input",()=>{
  db.ref("typing/public/"+currentUser.uid).set(currentUser.displayName);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>db.ref("typing/public/"+currentUser.uid).remove(),3000);
});

function setupTyping(){
  db.ref("typing/public").on("value",snap=>{
    const val=snap.val();
    if(val){
      const names=Object.values(val).filter(n=>n!==currentUser.displayName);
      typing.textContent=names.length?`${names.join(", ")} đang nhập...`:"";
    }else typing.textContent="";
  });
}
</script>
</body>
</html>
