<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Admin - ShynMMO Games</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
<style>
body{background:#0b0f19;color:#e5e7eb;font-family:Inter;margin:0;padding:20px}
.card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;margin:16px auto;max-width:1100px;box-shadow:0 0 20px rgba(0,0,0,.5)}
h2{margin:0 0 10px}
.nav{display:flex;gap:8px;margin:8px 0}
.nav button{border:none;border-radius:10px;padding:10px 14px;background:#121826;color:#fff;cursor:pointer}
.nav button.active{background:#22d3ee;color:#000;font-weight:800}
table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
th,td{padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.12);text-align:left}
th{color:#9fb0d1;text-transform:uppercase;font-size:12px;letter-spacing:.06em}
input,select,textarea,button{border:none;border-radius:10px;padding:10px;background:#121826;color:#fff}
button.primary{background:#22d3ee;color:#000;font-weight:800}
button.danger{background:#ef4444}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#121826;border:1px solid rgba(255,255,255,.12);font-size:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
footer{position:fixed;right:20px;bottom:10px;color:#888;font-size:12px;opacity:.6}
.small{font-size:12px;color:#9fb0d1}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="./js/firebase.js"></script>
<script src="./js/util.js"></script>
</head>
<body>

<div class="card">
  <h2>üõ† B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</h2>
  <div id="adminInfo" class="small">ƒêang ki·ªÉm tra quy·ªÅn...</div>

  <div class="nav">
    <button id="tabUsersBtn" class="active">T√†i kho·∫£n</button>
    <button id="tabCodesBtn">Giftcode</button>
    <button id="tabDepositBtn">C√†i ƒë·∫∑t n·∫°p</button>
  </div>

  <!-- USERS TAB -->
  <div id="tabUsers" class="card">
    <div class="row">
      <span class="small">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span>
      <button id="refreshUsers" class="primary" style="margin-left:auto">T·∫£i l·∫°i</button>
    </div>
    <div style="overflow:auto">
      <table id="usersTable">
        <thead>
          <tr>
            <th>UID</th><th>Username</th><th>Email</th><th>S·ªë d∆∞</th><th>Th·∫Øng</th><th>Thua</th><th>Role</th><th>Kh√≥a</th><th>H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="9">ƒêang t·∫£i...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- GIFTCODE TAB -->
  <div id="tabCodes" class="card" style="display:none">
    <h3>üéÅ T·∫°o Giftcode</h3>
    <div class="row">
      <input id="gc-code" placeholder="ƒê·ªÉ tr·ªëng ƒë·ªÉ random">
      <input id="gc-amount" type="number" placeholder="S·ªë ti·ªÅn + (vd 10000)">
      <input id="gc-max" type="number" placeholder="S·ªë l∆∞·ª£t d√πng (vd 3)">
      <button id="gc-random">Random</button>
      <button id="gc-create" class="primary">T·∫°o</button>
    </div>

    <h3 style="margin-top:16px">Danh s√°ch giftcode</h3>
    <div style="overflow:auto">
      <table id="codesTable">
        <thead><tr><th>Code</th><th>S·ªë ti·ªÅn</th><th>L∆∞·ª£t t·ªëi ƒëa</th><th>ƒê√£ d√πng</th><th>Tr·∫°ng th√°i</th><th>T·∫°o b·ªüi</th><th>H√†nh ƒë·ªông</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- DEPOSIT SETTINGS TAB -->
  <div id="tabDeposit" class="card" style="display:none">
    <h3>üí∞ Th√¥ng tin n·∫°p</h3>
    <textarea id="depositInfo" rows="6" placeholder="N·ªôi dung hi·ªÉn th·ªã cho ng∆∞·ªùi d√πng t·∫°i trang N·∫°p ti·ªÅn"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="saveDeposit" class="primary">L∆∞u</button>
      <span class="small">L∆∞u t·∫°i <code>settings/depositInfo</code></span>
    </div>
  </div>
</div>

<footer>¬© ShynMMO Games 2025</footer>

<script>
// Tab switching
function showTab(name){
  document.getElementById('tabUsers').style.display   = (name==='users')?'block':'none';
  document.getElementById('tabCodes').style.display   = (name==='codes')?'block':'none';
  document.getElementById('tabDeposit').style.display = (name==='deposit')?'block':'none';
  ['tabUsersBtn','tabCodesBtn','tabDepositBtn'].forEach(id=>{
    document.getElementById(id).classList.remove('active');
  });
  document.getElementById(name==='users'?'tabUsersBtn':name==='codes'?'tabCodesBtn':'tabDepositBtn').classList.add('active');
}
document.getElementById('tabUsersBtn').onclick=()=>showTab('users');
document.getElementById('tabCodesBtn').onclick=()=>showTab('codes');
document.getElementById('tabDepositBtn').onclick=()=>showTab('deposit');

requireAuth(async (user)=>{
  const prof=(await _db.ref('users/'+user.uid).get()).val();
  if(!prof || prof.role!=='admin'){ toast('B·∫°n kh√¥ng c√≥ quy·ªÅn admin'); location.href='login.html'; return; }
  document.getElementById('adminInfo').innerHTML = `ƒêƒÉng nh·∫≠p: <b>${prof.username}</b> <span class="badge">ADMIN</span>`;

  loadUsers();
  loadCodes();
  const depSnap=await _db.ref('settings/depositInfo').get();
  document.getElementById('depositInfo').value = depSnap.exists()? depSnap.val(): '';
});

// USERS
async function loadUsers(){
  const tbody=document.querySelector('#usersTable tbody'); tbody.innerHTML='';
  const snap=await _db.ref('users').get();
  if(!snap.exists()){ tbody.innerHTML='<tr><td colspan="9">Ch∆∞a c√≥ user</td></tr>'; return; }
  snap.forEach(cs=>{
    const u=cs.val(); const id=cs.key;
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td style="font-family:monospace">${id}</td>
      <td><input data-k="username" value="${u.username||''}"></td>
      <td><input data-k="email" value="${u.email||''}"></td>
      <td><input data-k="balance" type="number" value="${u.balance||0}" style="width:120px"></td>
      <td><input data-k="wins" type="number" value="${u.wins||0}" style="width:90px"></td>
      <td><input data-k="losses" type="number" value="${u.losses||0}" style="width:90px"></td>
      <td>
        <select data-k="role">
          <option value="user" ${u.role==='user'?'selected':''}>user</option>
          <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
        </select>
      </td>
      <td>
        <select data-k="locked">
          <option value="false" ${u.locked?'':'selected'}>m·ªü</option>
          <option value="true" ${u.locked?'selected':''}>kh√≥a</option>
        </select>
      </td>
      <td class="row">
        <button data-act="save" class="primary">L∆∞u</button>
        <button data-act="inc">+C·ªông</button>
        <button data-act="dec" class="danger">-Tr·ª´</button>
        <button data-act="hist">L·ªãch s·ª≠</button>
        <button data-act="del" class="danger">X√≥a</button>
      </td>`;
    tr.onclick = async (e)=>{
      const act=e.target?.dataset?.act;
      if(!act) return;
      const ref=_db.ref('users/'+id);
      if(act==='save'){
        const inputs=tr.querySelectorAll('[data-k]');
        const patch={};
        inputs.forEach(i=>{
          let v=i.value;
          if(i.type==='number') v=Number(v||0);
          if(i.dataset.k==='locked') v=(v==='true');
          patch[i.dataset.k]=v;
        });
        await ref.update(patch);
        toast('ƒê√£ l∆∞u');
      }else if(act==='del'){
        if(confirm('X√≥a user n√†y?')){ await ref.remove(); tr.remove(); }
      }else if(act==='hist'){
        // m·ªü trang l·ªãch s·ª≠ k√®m g·ª£i √Ω UID
        const u = new URL(location.href);
        const base = u.origin + u.pathname.replace('admin.html','lichsu.html');
        window.open('lichsu.html', '_blank');
      }else if(act==='inc' || act==='dec'){
        const amt = Number(prompt('Nh·∫≠p s·ªë ti·ªÅn '+(act==='inc'?'+C·ªông':'-Tr·ª´')));
        if(!amt || amt<=0) return;
        await ref.child('balance').transaction(b=>(b||0)+(act==='inc'?amt:-amt));
        await logTransaction(id,'admin',(act==='inc'?amt:-amt),null,(act==='inc'?'Admin c·ªông':'Admin tr·ª´'));
        toast((act==='inc'?'ƒê√£ c·ªông ':'ƒê√£ tr·ª´ ')+formatMoney(amt)+'ƒë');
      }
    };
    tbody.appendChild(tr);
  });
}
document.getElementById('refreshUsers').onclick=loadUsers;

// GIFTCODE
document.getElementById('gc-random').onclick = ()=> document.getElementById('gc-code').value = randomCode(12);
document.getElementById('gc-create').onclick = async ()=>{
  let code=(document.getElementById('gc-code').value.trim()||randomCode(12)).toUpperCase();
  const amount=Number(document.getElementById('gc-amount').value||0);
  const max=Number(document.getElementById('gc-max').value||1);
  if(amount<=0 || max<=0) return toast('S·ªë ti·ªÅn / l∆∞·ª£t d√πng kh√¥ng h·ª£p l·ªá');
  const ref=_db.ref('giftcodes/'+code);
  if((await ref.get()).exists()) return toast('Code ƒë√£ t·ªìn t·∫°i');
  await ref.set({ amount, maxUses:max, used:0, active:true, createdAt:Date.now(), createdBy:uid() });
  toast('ƒê√£ t·∫°o code '+code);
  loadCodes();
};
async function loadCodes(){
  const tbody=document.querySelector('#codesTable tbody'); tbody.innerHTML='';
  const snap=await _db.ref('giftcodes').get();
  if(!snap.exists()){ tbody.innerHTML='<tr><td colspan="7">Ch∆∞a c√≥ code</td></tr>'; return; }
  snap.forEach(cs=>{
    const code=cs.key, v=cs.val();
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="font-family:monospace">${code}</td>
      <td><input data-k="amount" type="number" value="${v.amount||0}"></td>
      <td><input data-k="maxUses" type="number" value="${v.maxUses||1}"></td>
      <td><span class="badge">${v.used||0}</span></td>
      <td>
        <select data-k="active">
          <option value="true" ${v.active?'selected':''}>b·∫≠t</option>
          <option value="false" ${!v.active?'selected':''}>t·∫Øt</option>
        </select>
      </td>
      <td style="font-family:monospace">${v.createdBy||''}</td>
      <td class="row">
        <button data-act="save" class="primary">L∆∞u</button>
        <button data-act="del" class="danger">X√≥a</button>
      </td>`;
    tr.onclick=async(e)=>{
      const act=e.target?.dataset?.act;
      const codeRef=_db.ref('giftcodes/'+code);
      if(act==='save'){
        const inputs=tr.querySelectorAll('[data-k]');
        const patch={};
        inputs.forEach(i=>{
          let val=i.value;
          if(i.type==='number') val=Number(val||0);
          if(i.dataset.k==='active') val=(val==='true');
          patch[i.dataset.k]=val;
        });
        await codeRef.update(patch);
        toast('ƒê√£ l∆∞u code');
      }else if(act==='del'){
        if(confirm('X√≥a code n√†y?')){ await codeRef.remove(); tr.remove(); }
      }
    };
    tbody.appendChild(tr);
  });
}

// DEPOSIT SETTINGS
document.getElementById('saveDeposit').onclick = async ()=>{
  await _db.ref('settings/depositInfo').set(document.getElementById('depositInfo').value);
  toast('ƒê√£ l∆∞u n·ªôi dung n·∫°p');
};
</script>
</body>
</html>
