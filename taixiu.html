<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>T√†i X·ªâu - ShynMMO Games</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
<style>
body{background:#0b0f19;color:#fff;font-family:Inter;margin:0;padding:20px}
.card{background:rgba(255,255,255,0.05);border-radius:15px;padding:20px;margin:20px auto;max-width:900px;box-shadow:0 0 15px rgba(0,0,0,0.5)}
input,select,button{border:none;border-radius:10px;padding:10px;margin:5px;background:#121826;color:#fff}
button{background:#22d3ee;color:#000;font-weight:700;cursor:pointer}
button:hover{background:#67e8f9}
.flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
.player-card{background:#111b2d;border-radius:12px;padding:10px;text-align:center}
footer{position:fixed;right:20px;bottom:10px;color:#888;font-size:12px;opacity:.6}
.small{color:#9fb0d1;font-size:13px}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="./js/firebase.js"></script>
<script src="./js/util.js"></script>
</head>
<body>
<div class="card">
  <h2>üé≤ T√†i X·ªâu realtime</h2>
  <div class="flex">
    <button id="btnLeave">R·ªùi ph√≤ng</button>
    <button id="btnRoll" style="display:none">X√≥c ƒëƒ©a</button>
  </div>
  <div id="info" class="small"></div>
  <hr>
  <div class="flex">
    <input id="roomName" placeholder="T√™n ph√≤ng">
    <button id="btnCreate">T·∫°o ph√≤ng</button>
  </div>
  <div id="rooms" class="grid"></div>
</div>

<footer>¬© ShynMMO Games 2025</footer>

<script>
requireAuth(async(u)=>{
  const ud=(await _db.ref('users/'+u.uid).get()).val();
  window.myUser={uid:u.uid,...ud};
  toast("Xin ch√†o "+myUser.username);
});

const roomsRef=_db.ref('rooms/taixiu');
roomsRef.on('value',snap=>{
  const wrap=$('#rooms');wrap.innerHTML='';
  if(!snap.exists()){wrap.innerHTML='<p>Ch∆∞a c√≥ ph√≤ng</p>';return;}
  snap.forEach(cs=>{
    const r=cs.val();const id=cs.key;
    const div=document.createElement('div');
    div.className='player-card';
    div.innerHTML=`<b>${r.name}</b><br>${Object.keys(r.players||{}).length} ng∆∞·ªùi<br><button data-id="${id}">V√†o ph√≤ng</button>`;
    div.querySelector('button').onclick=()=>joinRoom(id);
    wrap.appendChild(div);
  });
});

$('#btnCreate').onclick=async()=>{
  const name=$('#roomName').value.trim()||("Ph√≤ng "+Math.floor(Math.random()*999));
  const ref=roomsRef.push();
  await ref.set({name,hostUid:uid(),status:'waiting',createdAt:Date.now(),players:{}});
  joinRoom(ref.key);
};

async function joinRoom(roomId){
  const ref=_db.ref('rooms/taixiu/'+roomId+'/players/'+uid());
  const prof=(await _db.ref('users/'+uid()).get()).val();
  await ref.set({username:prof.username,choice:null,bet:0,result:null});
  loadRoom(roomId);
}

let currentRoom=null;
function loadRoom(id){
  currentRoom=id;
  const ref=_db.ref('rooms/taixiu/'+id);
  ref.on('value',snap=>{
    if(!snap.exists())return;
    const r=snap.val();const me=uid();
    const players=r.players||{};
    const info=$('#info');
    let html=`<h3>${r.name}</h3><p>Tr·∫°ng th√°i: ${r.status||'waiting'}</p>`;
    html+=`<div class='grid'>`;
    for(const k in players){
      const p=players[k];
      html+=`<div class='player-card'><b>${p.username}</b><br>${p.choice||'Ch∆∞a ch·ªçn'}<br>${formatMoney(p.bet)}</div>`;
    }
    html+='</div>';
    if(r.lastWinner) html+=`<p>üéâ Ch√∫c m·ª´ng <b>${r.lastWinner.username}</b> ƒë√£ th·∫Øng <b>${formatMoney(r.lastWinner.amount)}ƒë</b></p>`;
    info.innerHTML=html;
    $('#btnRoll').style.display=(r.hostUid===me)?'inline-block':'none';
  });
}

$('#btnLeave').onclick=async()=>{
  if(!currentRoom)return;
  await _db.ref('rooms/taixiu/'+currentRoom+'/players/'+uid()).remove();
  toast("ƒê√£ r·ªùi ph√≤ng");
};

// X√≥c ƒëƒ©a (Host)
$('#btnRoll').onclick=async()=>{
  if(!currentRoom)return;
  const ref=_db.ref('rooms/taixiu/'+currentRoom);
  const snap=await ref.get();
  const r=snap.val();const players=r.players||{};

  // K·∫øt qu·∫£ x√∫c x·∫Øc
  const dice=[1+Math.floor(Math.random()*6),1+Math.floor(Math.random()*6),1+Math.floor(Math.random()*6)];
  const total=dice.reduce((a,b)=>a+b,0);
  const result=(total>=11?'tai':'xiu');

  // Ti·ªÅn th∆∞·ªüng demo: 10k‚Äì500k
  const unit=10000;
  const prize = Math.min(500000, Math.max(10000, (1+Math.floor(Math.random()*50))*unit));
  let topWinner = null;

  for(const id in players){
    if(players[id].choice===result){
      // c·ªông ti·ªÅn + log + C·ªòNG BXH
      const userRef=_db.ref('users/'+id+'/balance');
      await userRef.transaction(b=>(b||0)+prize);
      await logTransaction(id,'win',prize,'taixiu','Th·∫Øng v√°n t√†i x·ªâu', currentRoom);
      await incLeaderboardOnWin('taixiu', id, prize); // <-- PATCH leaderboard

      if(!topWinner || prize > topWinner.amount){
        topWinner = { username: players[id].username, amount: prize };
      }
    }else{
      await logTransaction(id,'lose',-prize,'taixiu','Thua v√°n t√†i x·ªâu', currentRoom);
    }
  }

  await ref.update({dice,total,lastWinner: topWinner});
  toast("K·∫øt qu·∫£: "+result.toUpperCase()+" ("+total+")");
};
</script>
</body>
</html>
