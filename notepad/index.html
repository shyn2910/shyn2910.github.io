<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notepad Online â€” Shyn + Firebase</title>
  <style>
    :root{
      --bg:#0b0b0b; --card:#0f0f10; --accent:#ff2e2e; --muted:#9aa0a6;
    }
    body{font-family:Inter, system-ui, Arial; background:var(--bg); color:#fff; margin:0; min-height:100vh;
      display:flex; align-items:center; justify-content:center; padding:28px;}
    .wrap{width:100%;max-width:920px;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,.6)}
    textarea{width:100%;min-height:320px;background:#0a0a0a;border:1px solid #222;color:#eee;padding:12px;border-radius:10px;font-size:15px;resize:vertical}
    .row{display:flex;gap:10px;margin-top:10px;align-items:center}
    button{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    button.secondary{background:#2b2b2b;color:var(--muted)}
    .linkbox{margin-top:12px;background:#0a0a0a;padding:10px;border-radius:8px;word-break:break-all;display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .msg{margin-left:8px;color:#9fe39f}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ“ Notepad chia sáº» â€” Shyn + Firebase</h1>
    </header>

    <div class="card">
      <div class="small">Ghi chÃº (má»i thay Ä‘á»•i cáº§n báº¥m "LÆ°u" Ä‘á»ƒ ghi lÃªn server)</div>
      <textarea id="note" placeholder="Nháº­p ná»™i dung..." aria-label="notepad"></textarea>

      <div class="row">
        <button id="saveBtn">ğŸ’¾ LÆ°u & Láº¥y link</button>
        <button id="newBtn" class="secondary">ğŸ†• Táº¡o notepad má»›i</button>
        <button id="copyBtn" class="secondary">ğŸ“‹ Sao chÃ©p link</button>
        <div id="status" class="small" style="margin-left:12px"></div>
      </div>

      <div id="linkBox" class="linkbox" style="display:none">
        <div style="flex:1">
          <div class="small">Link chia sáº» (ai cÃ³ link cÅ©ng xem Ä‘Æ°á»£c):</div>
          <a id="shareLink" href="#" style="color:var(--accent);font-weight:600"></a>
        </div>
        <div id="time" class="small" style="text-align:right"></div>
      </div>

      <div style="margin-top:10px" class="small">
        LÆ°u Ã½: hÃ£y Ä‘iá»n <code>firebaseConfig</code> vÃ o chá»— <strong>REPLACE_WITH_YOUR_CONFIG</strong> trong mÃ£ bÃªn dÆ°á»›i
      </div>
    </div>
  </div>

  <!-- DÃ™NG modular SDK qua CDN. Náº¿u thay Ä‘á»•i phiÃªn báº£n, báº¡n cÃ³ thá»ƒ láº¥y tá»« hÆ°á»›ng dáº«n Firebase. -->
  <!-- TÃ i liá»‡u tham kháº£o: cÃ¡ch thÃªm SDK trÃªn web vÃ  Read/Write Realtime DB. -->
  <script type="module">
    // ====== BÆ¯á»šC Báº N PHáº¢I LÃ€M TRÆ¯á»šC ======
    // 1) Táº¡o Firebase Project â†’ Add Web app â†’ copy config vÃ  dÃ¡n vÃ o biáº¿n below.
    // 2) Táº¡o Realtime Database vÃ  (táº¡m thá»i) má»Ÿ rules test Ä‘á»ƒ public Ä‘á»c/ghi (hoáº·c tuá»³ chá»‰nh rules).
    //
    // Tham kháº£o: Firebase web setup / Realtime DB read & write. :contentReference[oaicite:3]{index=3}

    // ----- Thay chá»— nÃ y báº±ng config cá»§a báº¡n (láº¥y tá»« Firebase console) -----
const firebaseConfig = {
  apiKey: "AIzaSyD5sSqWNPeKRI-TYGWaJ2CHJgVhK9NEeRA",
  authDomain: "shynsuite.firebaseapp.com",
  databaseURL: "https://shynsuite-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shynsuite",
  storageBucket: "shynsuite.firebasestorage.app",
  messagingSenderId: "555918093845",
  appId: "1:555918093845:web:30a1bb173ed09e0c9c281c",
  measurementId: "G-X2CWCT2GWY"
};

    if (!firebaseConfig.apiKey) {
      document.getElementById('status').textContent = 'âš ï¸ ChÆ°a cÃ i firebaseConfig. Má»Ÿ file, dÃ¡n config tá»« Firebase Console.';
    }

    // ----- Import modular SDK (Realtime DB) tá»« CDN -----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, push, get, child, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Init Firebase
    let app = null;
    let db = null;
    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
    } catch (e) {
      // náº¿u config rá»—ng => firebase init lá»—i
      console.warn('Firebase chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘Ãºng:', e);
    }

    // DOM
    const noteEl = document.getElementById('note');
    const saveBtn = document.getElementById('saveBtn');
    const newBtn = document.getElementById('newBtn');
    const copyBtn = document.getElementById('copyBtn');
    const linkBox = document.getElementById('linkBox');
    const shareLink = document.getElementById('shareLink');
    const status = document.getElementById('status');
    const timeEl = document.getElementById('time');

    // Helper: láº¥y id tá»« URL hoáº·c táº¡o má»›i
    function getNoteIdFromURL() {
      const p = new URLSearchParams(location.search);
      return p.get('id');
    }

    function updateURLWithId(id) {
      const url = new URL(location.href);
      url.searchParams.set('id', id);
      history.replaceState(null, '', url.toString());
    }

    function nowISO() {
      return new Date().toISOString();
    }

    // Táº¡o note má»›i: sinh id ngáº«u nhiÃªn vÃ  clear textarea
    function createNewNote() {
      const newid = Math.random().toString(36).slice(2,10);
      updateURLWithId(newid);
      noteEl.value = '';
      linkBox.style.display = 'none';
      status.textContent = 'âœ¨ Notepad má»›i sáºµn sÃ ng (id=' + newid + ')';
      return newid;
    }

    // Hiá»ƒn thá»‹ link
    function showShareLink(id) {
      const url = new URL(location.href);
      url.searchParams.set('id', id);
      shareLink.href = url.toString();
      shareLink.textContent = url.toString();
      linkBox.style.display = 'flex';
      timeEl.textContent = new Date().toLocaleString();
    }

    // LÆ¯U note lÃªn Firebase Realtime Database:
    // Cáº¥u trÃºc DB: /notes/{id} => { content, updatedAt }
    async function saveNoteToFirebase(id, content) {
      if (!db) throw new Error('Firebase chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh.');
      const path = 'notes/' + id;
      const noteRef = ref(db, path);
      await set(noteRef, {
        content: content,
        updatedAt: nowISO()
      });
    }

    // Táº¢I note tá»« Firebase (1 láº§n)
    async function loadNoteFromFirebase(id) {
      if (!db) return null;
      const path = 'notes/' + id;
      const noteRef = ref(db, path);
      const snap = await get(noteRef);
      if (snap && snap.exists()) return snap.val();
      return null;
    }

    // Láº¯ng nghe thay Ä‘á»•i realtime (náº¿u muá»‘n auto-update khi ai Ä‘Ã³ chá»‰nh)
    function watchNoteRealtime(id) {
      if (!db) return;
      const path = 'notes/' + id;
      const noteRef = ref(db, path);
      onValue(noteRef, (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          // Náº¿u ná»™i dung khÃ¡c háº³n vá»›i Ã´ nháº­p hiá»‡n táº¡i, cáº­p nháº­t (khÃ´ng overwrite náº¿u Ä‘ang edit)
          if (noteEl.value !== data.content) {
            noteEl.value = data.content;
            status.textContent = 'ğŸ” Ná»™i dung Ä‘Ã£ cáº­p nháº­t (realtime)';
          }
          timeEl.textContent = new Date(data.updatedAt).toLocaleString();
          showShareLink(id);
        }
      });
    }

    // Khi báº¥m LÆ¯U
    saveBtn.addEventListener('click', async () => {
      const id = getNoteIdFromURL() || createNewNote();
      const content = noteEl.value;
      if (!db) { alert('Firebase chÆ°a cáº¥u hÃ¬nh. Má»Ÿ file vÃ  dÃ¡n firebaseConfig.'); return; }
      status.textContent = 'â³ Äang lÆ°u...';
      try {
        await saveNoteToFirebase(id, content);
        status.textContent = 'âœ… ÄÃ£ lÆ°u lÃªn Firebase';
        showShareLink(id);
        // start watching realtime (so that others edits reflect)
        watchNoteRealtime(id);
      } catch (e) {
        console.error(e);
        status.textContent = 'âŒ LÆ°u tháº¥t báº¡i: ' + (e.message || e);
        alert('LÆ°u tháº¥t báº¡i. Kiá»ƒm tra firebaseConfig vÃ  rules Realtime Database.');
      }
    });

    // Táº¡o notepad má»›i
    newBtn.addEventListener('click', () => {
      createNewNote();
    });

    // Copy link
    copyBtn.addEventListener('click', async () => {
      const href = shareLink.href;
      if (!href) { alert('ChÆ°a cÃ³ link Ä‘á»ƒ copy. HÃ£y lÆ°u trÆ°á»›c.'); return; }
      try {
        await navigator.clipboard.writeText(href);
        status.textContent = 'ğŸ“‹ ÄÃ£ copy link';
      } catch (e) {
        alert('TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ tÃ­nh nÄƒng copy tá»± Ä‘á»™ng. HÃ£y copy thá»§ cÃ´ng.');
      }
    });

    // Khi má»Ÿ trang: náº¿u cÃ³ id trong URL thÃ¬ load tá»« Firebase; náº¿u khÃ´ng thÃ¬ táº¡o id má»›i local
    (async function init() {
      const id = getNoteIdFromURL();
      if (id) {
        status.textContent = 'â³ Äang táº£i note tá»« server...';
        if (!db) { status.textContent = 'âš ï¸ Firebase chÆ°a cáº¥u hÃ¬nh.'; return; }
        try {
          const data = await loadNoteFromFirebase(id);
          if (data) {
            noteEl.value = data.content || '';
            status.textContent = 'âœ… ÄÃ£ táº£i note (id=' + id + ')';
            showShareLink(id);
            // Khá»Ÿi Ä‘á»™ng láº¯ng nghe realtime Ä‘á»ƒ tá»± Ä‘á»™ng cáº­p nháº­t khi cÃ³ thay Ä‘á»•i
            watchNoteRealtime(id);
          } else {
            status.textContent = 'â„¹ï¸ ChÆ°a cÃ³ note táº¡i id nÃ y. Báº¡n cÃ³ thá»ƒ nháº­p ná»™i dung vÃ  báº¥m LÆ°u.';
            showShareLink(id);
          }
        } catch (e) {
          console.error(e);
          status.textContent = 'âŒ Lá»—i khi táº£i: ' + (e.message||e);
        }
      } else {
        // khÃ´ng cÃ³ id â†’ táº¡o má»›i (má»›i local, chÆ°a lÆ°u server)
        createNewNote();
      }
    })();

  </script>
</body>
</html>
