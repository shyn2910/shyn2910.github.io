<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Shyn System</title>

<!-- ✅ Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<style>
body{font-family:Arial;background:#0d1117;color:white;}
section{background:#161b22;margin:10px;padding:15px;border-radius:10px;}
button{background:#238636;color:white;border:none;padding:8px 12px;margin:4px;border-radius:5px;cursor:pointer;}
button:hover{background:#2ea043;}
input{padding:6px;border:none;border-radius:5px;margin:4px;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #30363d;padding:6px;text-align:center;}
</style>
</head>
<body>
<h2>👋 Xin chào <span id="uname"></span> (<span id="urole"></span>)</h2>
<p>Số dư: <b id="ubalance"></b> 💰</p>
<button onclick="logout()">Đăng xuất</button>

<section>
  <h3>📋 To-do List</h3>
  <input id="todo" placeholder="Nhiệm vụ...">
  <button onclick="addTodo()">Thêm</button>
  <ul id="todoList"></ul>
</section>

<section>
  <h3>🔗 Liên kết cá nhân</h3>
  <input id="lname" placeholder="Tên nút">
  <input id="lurl" placeholder="URL">
  <button onclick="addLink()">Thêm</button>
  <div id="links"></div>
</section>

<section>
  <h3>💵 Nạp qua Giftcode</h3>
  <input id="gift" placeholder="Nhập Giftcode...">
  <button onclick="redeem()">Xác nhận</button>
</section>

<section id="admin" style="display:none">
  <h3>⚙️ Bảng điều khiển Admin</h3>
  <input id="giftCode" placeholder="Tạo Giftcode">
  <input id="giftValue" type="number" placeholder="Giá trị">
  <button onclick="createGift()">Tạo Giftcode</button>
  <button onclick="loadUsers()">Tải danh sách user</button>
  <table id="userTable"></table>
</section>

<script>
// ================== ⚙️ Firebase Config (Shyn App) ==================
const firebaseConfig = {
  apiKey: "AIzaSyD9XW1A1ns5cYlV3bI5i4HigR9HyUUYlvQ",
  authDomain: "shyn-app-0709.firebaseapp.com",
  databaseURL: "https://shyn-app-0709-default-rtdb.firebaseio.com",
  projectId: "shyn-app-0709",
  storageBucket: "shyn-app-0709.appspot.com",
  messagingSenderId: "660274057745",
  appId: "1:660274057745:web:ef7300abd53dec95d9d7b0",
  measurementId: "G-2ZKCQ24770"
};
// ==========================================================
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const uname = localStorage.getItem('currentUser');
if (!uname) location.href = "index.html";
let userData;

const unameEl = document.getElementById('uname');
const uroleEl = document.getElementById('urole');
const ubalanceEl = document.getElementById('ubalance');

async function loadUser() {
  const snap = await db.ref('users/' + uname).get();
  userData = snap.val();
  unameEl.textContent = uname;
  uroleEl.textContent = userData.role;
  ubalanceEl.textContent = userData.balance + " VND";
  if (userData.role === "admin") document.getElementById('admin').style.display = 'block';
  renderTodos();
  renderLinks();
}
loadUser();

// ================= To-do List =================
function renderTodos() {
  const ul = document.getElementById('todoList'); ul.innerHTML = "";
  (userData.todos || []).forEach((t, i) => {
    const li = document.createElement('li'); li.textContent = t;
    li.onclick = () => { userData.todos.splice(i, 1); saveUser(); };
    ul.appendChild(li);
  });
}
function addTodo() {
  const t = document.getElementById('todo').value.trim(); if (!t) return;
  userData.todos = userData.todos || []; userData.todos.push(t); saveUser();
  document.getElementById('todo').value = "";
}

// ================= Links =================
function renderLinks() {
  const div = document.getElementById('links'); div.innerHTML = "";
  (userData.links || []).forEach(l => {
    const b = document.createElement('button'); b.textContent = l.name;
    b.onclick = () => window.open(l.url, '_blank'); div.appendChild(b);
  });
}
function addLink() {
  const n = lname.value.trim(), u = lurl.value.trim(); if (!n || !u) return;
  userData.links = userData.links || []; userData.links.push({ name: n, url: u });
  saveUser(); lname.value = ""; lurl.value = "";
}

// ================= Giftcode =================
async function redeem() {
  const code = gift.value.trim();
  const snap = await db.ref('giftcodes/' + code).get();
  if (!snap.exists()) { alert("❌ Giftcode không hợp lệ!"); return; }
  const val = snap.val();
  if (val.used) { alert("🚫 Giftcode đã được sử dụng!"); return; }
  userData.balance += val.amount;
  await db.ref('users/' + uname).set(userData);
  await db.ref('giftcodes/' + code + '/used').set(true);
  alert("🎉 Nạp " + val.amount + " VND thành công!");
  loadUser(); gift.value = "";
}

// ================= Admin Panel =================
async function createGift() {
  const code = giftCode.value.trim(); const value = parseInt(giftValue.value);
  if (!code || !value) return alert("Nhập mã và giá trị hợp lệ!");
  await db.ref('giftcodes/' + code).set({ amount: value, used: false });
  alert("✅ Tạo giftcode thành công!");
  giftCode.value = ""; giftValue.value = "";
}
async function loadUsers() {
  const snap = await db.ref('users').get();
  const data = snap.val();
  let html = "<tr><th>Tên</th><th>Role</th><th>Balance</th><th>Block</th><th>Action</th></tr>";
  for (let k in data) {
    const u = data[k];
    html += `<tr>
      <td>${k}</td><td>${u.role}</td><td>${u.balance}</td>
      <td>${u.blocked ? '🚫' : '✅'}</td>
      <td><button onclick="blockUser('${k}',${!u.blocked})">${u.blocked ? 'Mở' : 'Block'}</button></td>
    </tr>`;
  }
  userTable.innerHTML = html;
}
async function blockUser(name, state) {
  await db.ref('users/' + name + '/blocked').set(state);
  alert("Đã cập nhật trạng thái!");
  loadUsers();
}

// ================= Save & Logout =================
async function saveUser() { await db.ref('users/' + uname).set(userData); loadUser(); }
function logout() { localStorage.removeItem('currentUser'); location.href = "index.html"; }
</script>
</body>
</html>
